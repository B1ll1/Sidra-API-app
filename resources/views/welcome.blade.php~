<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Laravel</title>

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Raleway:100,600" rel="stylesheet" type="text/css">

        <!-- Styles -->
        <style>
            html, body {
                background-color: #fff;
                color: #636b6f;
                font-family: 'Raleway', sans-serif;
                font-weight: 100;
                height: 100vh;
                margin: 0;
            }

            .full-height {
                height: 100vh;
            }

            .flex-center {
                align-items: center;
                display: flex;
                justify-content: center;
            }

            .position-ref {
                position: relative;
            }

            .top-right {
                position: absolute;
                right: 10px;
                top: 18px;
            }

            .content {
                text-align: center;
            }

            .title {
                font-size: 84px;
            }

            .links > a {
                color: #636b6f;
                padding: 0 25px;
                font-size: 12px;
                font-weight: 600;
                letter-spacing: .1rem;
                text-decoration: none;
                text-transform: uppercase;
            }

            .m-b-md {
                margin-bottom: 30px;
            }
        </style>
    </head>
    <body>
        <div class="flex-center position-ref full-height">
            @if (Route::has('login'))
                <div class="top-right links">
                    <a href="{{ url('/login') }}">Login</a>
                    <a href="{{ url('/register') }}">Register</a>
                </div>
            @endif

            <div class="content">
                <div class="title m-b-md">
                    Laravel
                </div>

                <div class="links">
                    <a href="https://laravel.com/docs">Documentation</a>
                    <a href="https://laracasts.com">Laracasts</a>
                    <a href="https://laravel-news.com">News</a>
                    <a href="https://forge.laravel.com">Forge</a>
                    <a href="https://github.com/laravel/laravel">GitHub</a>
                </div>
            </div>
        </div>
    </body>
</html>


<script type="text/javascript">

        var prodUF;
        var qtdProdUF;
        var anoPAM;
        var tabelaSidra = 1612;
        var classificacaoLavouraSidra = 81;

        $(document).ready(inicializa());

        function inicializa() {
            prodUF = new Array();
            qtdProdUF = 0;

            var prodAnt = 0;
            var linha;

            //
            // Efetua a leitura da quantidade produzida dos produtos da lavoura e as UFs produtoras
            //
            //var apiURL = "http://www.sidra.ibge.gov.br/api/values/h/n/t/" + tabelaSidra + "/c" + classificacaoLavouraSidra + "/allxt/n3/all/p/last/v/214";
            var apiURL = "/api/values/h/n/t/" + tabelaSidra + "/c" + classificacaoLavouraSidra + "/allxt/n3/all/p/last/v/214";

            $.ajax({
                url: apiURL,
                crossDomain: false,
                dataType: "json",
                success: function (data) {
                    $('#claf').empty();
                    $.each(data,
                        function (key, val) {
                            if (isNumber(val.V)) {    // Pula as linhas com valor não numérico (- X .. ... etc)
                                var lin = new Array(val.D1C, val.D1N, val.D2C, val.D2N, val.MN, val.V);
                                prodUF[qtdProdUF++] = lin;
                                if (val.D1C != prodAnt) {
                                    linha = "<option value='" + val.D1C + "'>" + val.D1N + " (" + val.MN + ")</option>";
                                    $(linha).appendTo($('#claf'));
                                    prodAnt = val.D1C;
                                    anoPAM = val.D3C;
                                }
                            }
                        }
                    );
                    listaUF(prodUF[0][0]);
                    $('#titulo').empty();
                    $('#titulo').text('Produção Agrícola Municipal ' + anoPAM);
                },
                error: function (jqXHR, textStatus, err) {
                    alert(jqXHR.responseText);
                }
            });
        }

        function consultar() {
            var n3 = $("#n3").val();
            var claf = $("#claf").val();
            var valTotal = 0;
            var primeiraLinha = true;
            var unidadeMedida;

            if (n3 < 10) {    // Se selecionou uma Grande Região
                alert("Selecione a Unidade da Federação");
                return;
            }

            $('#resultado').empty();
            var aguarde = "<tr><td><font color='green'><b>Aguarde...</b></font></td></tr>";
            $(aguarde).appendTo($('#resultado'));

            //
            // Efetua a leitura dos municípios de uma UF que produzem um produto da lavoura
            //
            //var apiURL = "http://www.sidra.ibge.gov.br/api/values/h/n/t/" + tabelaSidra + "/n6/in n3 " + n3 + "/p/last/v/214/c" + classificacaoLavouraSidra + "/" + claf;
            var apiURL = "/api/values/h/n/t/" + tabelaSidra + "/n6/in n3 " + n3 + "/p/last/v/214/c" + classificacaoLavouraSidra + "/" + claf;

            $.ajax({
                url: apiURL,
                crossDomain: false,
                dataType: "json",
                success: function (data) {
                    $.each(data,
                        function (key, val) {
                            if (isNumber(val.V)) {  // Pula as linhas com valor não numérico (- X .. ... etc)
                                if (primeiraLinha) {
                                    $('#resultado').empty();
                                    primeiraLinha = false;
                                    unidadeMedida = val.MN;
                                }
                                var linha = "<tr><td>" + val.D1C + "</td><td>" + val.D1N.substr(0, val.D1N.length - 5) + "</td><td align='right'>" + formatMoney(val.V, 0, '', ' ', ',') + "</td></tr>";
                                $(linha).appendTo($('#resultado'));
                                valTotal += parseFloat(val.V);
                            }
                        }
                    );
                        var cabecalho = "<tr><th colspan='3'>Quantidade produzida de " + pegaNomeProduto(claf) + " (" + unidadeMedida + ") nos municípios da Unidade da Federação<br />" + pegaNomeUF(n3) + " - " + anoPAM + "</th></tr>" +
                                        "<tr><th>Código</th><th>Nome</th><th>Valor</th></tr>" +
                                        "<tr><td></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Total</td><td align='right'>" + formatMoney(valTotal, 0, '', ' ', ',') + "</td></tr>";
                    $(cabecalho).prependTo($('#resultado'));
                },
                error: function (jqXHR, textStatus, err) {
                    alert(jqXHR.responseText);
                }
            });
        }

        function isNumber(nro) {
            return !isNaN(parseFloat(nro)) && isFinite(nro);
        }

        //
        // (c) Joss Crowcroft - Software engineer
        //
        function formatMoney(number, places, symbol, thousand, decimal) {
            number = number || 0;
            places = !isNaN(places = Math.abs(places)) ? places : 2;
            symbol = symbol !== undefined ? symbol : "$";
            thousand = thousand || ",";
            decimal = decimal || ".";
            var negative = number < 0 ? "-" : "",
            i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
            j = (j = i.length) > 3 ? j % 3 : 0;
            return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
        }

        function listaUF(codProd) {
            var i;
            var linha;
            var vetGR = new Array(0, new Array(false, 1, '--- Região Norte ---'), new Array(false, 2, '--- Região Nordeste ---'), new Array(false, 3, '--- Região Sudeste ---'), new Array(false, 4, '--- Região Sul ---'), new Array(false, 5, '--- Região Centro-Oeste ---'));
            var codGR;
            var primeiraUF = true;
            $('#n3').empty();
            for (i = 0; i < qtdProdUF; i++) {
                if (prodUF[i][0] == codProd) {
                    codGR = prodUF[i][2].substr(0, 1);
                    if (vetGR[codGR][0] == false) {
                        linha = "<option value='" + vetGR[codGR][1] + "'>" + vetGR[codGR][2] + "</option>";
                        $(linha).appendTo($('#n3'));
                        vetGR[codGR][0] = true;
                    }
                    if (primeiraUF) {
                        linha = "<option value='" + prodUF[i][2] + "' selected='selected'>" + prodUF[i][3] + " (" + formatMoney(prodUF[i][5], 0, '', ' ', ',') + " " + prodUF[i][4] + ")</option>";
                        primeiraUF = false;
                    } else {
                        linha = "<option value='" + prodUF[i][2] + "'>" + prodUF[i][3] + " (" + formatMoney(prodUF[i][5], 0, '', ' ', ',') + " " + prodUF[i][4] + ")</option>";
                    }
                    $(linha).appendTo($('#n3'));
                }
            }
        }

        function escolheuLavoura() {
            var linha;
            var codLavoura = $("#lavoura").val();
            if (codLavoura == 't') {
                tabelaSidra = 1612;
                classificacaoLavouraSidra = 81;
            } else {
                tabelaSidra = 1613;
                classificacaoLavouraSidra = 82;
            }
            $('#claf').empty();
            linha = "<option value='0'>&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;</option>";
            $(linha).appendTo($('#claf'));
            $('#n3').empty();
            linha = "<option value='0'>&nbsp;&nbsp;Aguarde...&nbsp;&nbsp;</option>";
            $(linha).appendTo($('#n3'));
            $('#resultado').empty();
            inicializa();
        }

        function escolheuProduto() {
            var codProd = $("#claf").val();
            listaUF(codProd);
        }

        function pegaNomeProduto(codProd) {
            var i;
            for (i = 0; i < qtdProdUF; i++) {
                if (prodUF[i][0] == codProd) {
                    return prodUF[i][1];
                }
            }
        }

        function pegaNomeUF(codUF) {
            var i;
            for (i = 0; i < qtdProdUF; i++) {
                if (prodUF[i][2] == codUF) {
                    return prodUF[i][3];
                }
            }
        }

</script>